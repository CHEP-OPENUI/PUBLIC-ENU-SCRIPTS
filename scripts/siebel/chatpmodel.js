/*<ORACLECOPYRIGHT>
* Copyright (C) 1994-2013 Oracle and/or its affiliates. All rights reserved.
* Oracle and Java are registered trademarks of Oracle and/or its affiliates.
* Other names may be trademarks of their respective owners.
* UNIX is a registered trademark of The Open Group.
*
* This software and related documentation are provided under a license agreement
* containing restrictions on use and disclosure and are protected by intellectual property laws.
* Except as expressly permitted in your license agreement or allowed by law, you may not use, copy,
* reproduce, translate, broadcast, modify, license, transmit, distribute, exhibit, perform, publish,
* or display any part, in any form, or by any means. Reverse engineering, disassembly,
* or decompilation of this software, unless required by law for interoperability, is prohibited.
*
* The information contained herein is subject to change without notice and is not warranted to be error-free.
* If you find any errors, please report them to us in writing.
*
* U.S. GOVERNMENT RIGHTS Programs, software, databases, and related documentation and technical data delivered to U.S.
* Government customers are "commercial computer software" or "commercial technical data" pursuant to the applicable
* Federal Acquisition Regulation and agency-specific supplemental regulations.
* As such, the use, duplication, disclosure, modification, and adaptation shall be subject to the restrictions and
* license terms set forth in the applicable Government contract, and, to the extent applicable by the terms of the
* Government contract, the additional rights set forth in FAR 52.227-19, Commercial Computer Software License
* (December 2007). Oracle America, Inc., 500 Oracle Parkway, Redwood City, CA 94065.
*
* This software or hardware is developed for general use in a variety of information management applications.
* It is not developed or intended for use in any inherently dangerous applications, including applications that
* may create a risk of personal injury. If you use this software or hardware in dangerous applications,
* then you shall be responsible to take all appropriate fail-safe, backup, redundancy,
* and other measures to ensure its safe use. Oracle Corporation and its affiliates disclaim any liability for any
* damages caused by use of this software or hardware in dangerous applications.
*
* This software or hardware and documentation may provide access to or information on content,
* products, and services from third parties. Oracle Corporation and its affiliates are not responsible for and
* expressly disclaim all warranties of any kind with respect to third-party content, products, and services.
* Oracle Corporation and its affiliates will not be responsible for any loss, costs,
* or damages incurred due to your access to or use of third-party content, products, or services.
</ORACLECOPYRIGHT>*/
if(typeof(SiebelAppFacade.ChatPresentationModel)==="undefined"){SiebelJS.Namespace("SiebelAppFacade.ChatPresentationModel");SiebelAppFacade.ChatPresentationModel=(function(){var r=SiebelJS.Dependency("SiebelApp.Constants");var A=SiebelJS.Dependency("SiebelApp.Utils");var d=3000;function e(){SiebelAppFacade.ChatPresentationModel.superclass.constructor.call(this,{GetName:function(){return"ChatObject"}})}SiebelJS.Extend(e,SiebelAppFacade.PresentationModel);e.prototype.Init=function(){this.AddProperty("ChatSysPref",{bEnableBlinkTab:false,nCustomerTypeDisplayTime:d,nAgentTypeDetectInterval:d});this.AddProperty("ChatTabMap",{});this.AddProperty("CurrentChat",null);this.AddProperty("CurrentTabOnHold",null);this.AddProperty("NewChatMessage",null);this.AddProperty("ShowTypingMsg",null);this.AddProperty("ChatIdRemoved",null);this.AddProperty("ChatUpdated",null);this.AddProperty("ChatIdHold",null);this.AddProperty("ChatResumed",null);this.AddProperty("ChatClearLog",null);this.AddProperty("TextInput4Set",null);this.AddProperty("UrlInput4Set",null);this.AddProperty("ReadLastMessage",null);this.AddProperty("SetFocus",null);this.AddProperty("ChatSetFocusEventList",null);this.AddMethod("InvokeServiceMethod",function(H,I,J){var G=SiebelApp.S_App.GetService(r.get("NAME_CHATUISVC"));if(G){p(3,"Open UI - Chat: Invoke Chat UI Business Service Method: "+H);if(!I){I=CCFMiscUtil_CreatePropSet()}I.SetPropertyStr(r.get("CHATUISVC_TAG_METHOD"),H);J=G.InvokeMethod(H,I);if(J){var L=J.GetChildByType(r.get("CHATCC_PROPSET_TYPE_RESULT"));if(L){var K=L.GetProperty(r.get("CHATUISVC_TAG_METHOD"));if(K){D.call(this,K,L)}}}}else{p(1,"Open UI - Chat: Chat UI Business Service Not Found!")}});this.AddMethod("GetCurrChatId",function(){var G=this.Get("CurrentChat");if(G){return G.Id}else{return""}});this.AddMethod("AgentTyping",function(G){var H=this.Get("ChatTabMap")[G];if(H){if((new Date().getTime()-H.agentTypingSentTime)>=this.Get("ChatSysPref").nAgentTypeDetectInterval){H.agentTypingSentTime=new Date().getTime();var I=CCFMiscUtil_CreatePropSet();I.SetProperty("InteractionId",G);I.SetPropertyStr("SWEBS","1");this.ExecuteMethod("InvokeServiceMethod",r.get("CHATUISVC_METHOD_SENDAGENTTYPINGMSG"),I)}}});this.AddMethod("SendMessage",function(G){if(G&&G.chatId&&G.text){var H=CCFMiscUtil_CreatePropSet();H.SetProperty("InteractionId",G.chatId);H.SetProperty("Text",G.text);this.ExecuteMethod("InvokeServiceMethod",r.get("CHATUISVC_METHOD_SENDMESSAGE"),H)}});this.AddMethod("ImplicitSave",function(){return n()});this.AddMethod("SwitchChat",function(H,G){F.call(this,H,G)});this.AddMethod("LoadChatData",function(){f.call(this)});this.AddMethod("HoldTab",function(G){B.call(this,G)});this.AddMethod("GetTextInputValue",function(){u.call(this)});this.AddMethod("GetUrlInputValue",function(){z.call(this)});this.AddMethod("LogMsg",function(H,G){a.call(this,H,G)});this.AddMethod("CloseChatPane",function(){l.call(this)});this.AddMethod("SetFocus",function(){this.SetProperty("SetFocus",true)});this.AttachEventHandler(r.get("CHAT_PANE_CLOSE"),function(){l.call(this);SiebelApp.S_App.UnregisterExtObject("ChatPane")})};function k(){this.SetProperty("ChatSysPref",{bEnableBlinkTab:false,nCustomerTypeDisplayTime:d,nAgentTypeDetectInterval:d});this.SetProperty("ChatTabMap",{});this.SetProperty("CurrentChat",null);this.SetProperty("CurrentTabOnHold",null);this.SetProperty("NewChatMessage",null);this.SetProperty("ShowTypingMsg",null);this.SetProperty("ChatIdRemoved",null);this.SetProperty("ChatUpdated",null);this.SetProperty("ChatIdHold",null);this.SetProperty("ChatResumed",null);this.SetProperty("ChatClearLog",null);this.SetProperty("TextInput4Set",null);this.SetProperty("UrlInput4Set",null);this.SetProperty("SetFocus",null);this.SetProperty("ChatSetFocusEventList",null)}e.prototype.Setup=function(G){G.SetProperty("SWE_OUI_RENDERER","ChatPhyRenderer");SiebelAppFacade.ChatPresentationModel.superclass.Setup.call(this,G);q.call(this,G)};e.prototype.HandleNotify=function(G){this.AddProperty("LocaleInfo",{});q.call(this,G)};e.prototype.Notify=function(H){var G=this;H.each(function(){var I=CCFMiscUtil_CreatePropSet();I.DecodeFromString($(this).text());var J=I.GetProperty(r.get("CHATUISVC_TAG_EVENT"));D.call(G,J,I)})};function D(P,S){if(!S||S.IsEmpty()){return}switch(P){case r.get("CHATUISVC_METHOD_INITIALIZEAX"):var H=S.GetPropertyAsStr(r.get("CHATUISVC_TAG_ENABLE_BLINKTAB"));var V=S.GetPropertyAsStr(r.get("CHATUISVC_TAG_TYPEDISTIME"));var I=S.GetPropertyAsStr(r.get("CHATUISVC_TAG_TYPEDECINTERVAL"));var R=this.Get("ChatSysPref");var J=S.GetPropertyAsStr("ChatSetFocusEventList");this.SetProperty("ChatSetFocusEventList",v(J));if(H&&H===r.get("CHATUISVC_VALUE_YES")){R.bEnableBlinkTab=true}if(V){var N=parseInt(V,10);if(N>0){R.nCustomerTypeDisplayTime=N*1000}}if(I){var N=parseInt(I,10);if(N>0){R.nAgentTypeDetectInterval=N*1000}}var G=CCFMiscUtil_CreatePropSet();G.SetProperty(r.get("CHATUISVC_TAG_NEEDTYPEINFO"),"TRUE");this.ExecuteMethod("InvokeServiceMethod",r.get("CHATUISVC_METHOD_UPDATECHATDATA"),G);break;case r.get("CHATUISVC_METHOD_UPDATECHATDATA"):m.call(this,S);break;case r.get("CHATUISVC_METHOD_GETFIELDDATA"):j.call(this,S);break;case r.get("CHATUISVC_METHOD_GETSMARTSHARETEXT"):break;case r.get("CHATUISVC_EVENT_ENDCHAT"):case r.get("CHATUISVC_EVENT_WRAPUPCHAT"):g.call(this,S);var M=S.GetPropertyAsStr(r.get("CHATUISVC_TAG_EVENTCHATID"));if(M===this.ExecuteMethod("GetCurrChatId")){}break;case r.get("CHATUISVC_EVENT_NEWMESSAGEINACTIVE"):case r.get("CHATUISVC_EVENT_UPDATECHATDISPLAYNAME"):case r.get("CHATUISVC_EVENT_ACCEPTCHATHOLD"):g.call(this,S);break;case r.get("CHATUISVC_EVENT_HOLDCHAT"):y.call(this,S);break;case r.get("CHATUISVC_EVENT_ACCEPTCHAT"):case r.get("CHATUISVC_EVENT_RESUMECHAT"):s.call(this,P,S);break;case r.get("CHATUISVC_EVENT_NEWMESSAGE"):C.call(this,S);break;case r.get("CHATUISVC_EVENT_UPDATEDATAFIELD"):var L=S.GetPropertyAsStr(r.get("CHATUISVC_TAG_CURRCHATID"));if(L!==this.ExecuteMethod("GetCurrChatId")){p(1,"Current chat id does not match!")}var G=S.Clone();this.ExecuteMethod("InvokeServiceMethod",r.get("CHATUISVC_METHOD_GETFIELDDATA"),G);break;case r.get("CHATUISVC_METHOD_REFRESHCHATPANEDASHBOARD"):break;case r.get("CHATUISVC_EVENT_SHOWTYPINGMSG"):w.call(this,S);break;default:break}var T=this.Get("ChatSetFocusEventList");var U=P.toUpperCase();for(var K=0,Q=T.length;K<Q;K++){if(U==T[K]){var O=this.ExecuteMethod("GetCurrChatId");if(O&&Candy.Wrapper.Room.exists(O)){if(Candy.Accessibility.Room.Input.isDisabled(O)){Candy.Accessibility.Room.Tab.setFocus(O)}else{Candy.Accessibility.Room.Input.setFocus(O)}}break}}}function v(H){var G=[];H=H.replace(/\s+/g,"");if(H.length>0){var K=H.toUpperCase();G=K.split(";");for(var J=0,I=G.length;J<I;J++){if(G[J].length==0){G.splice(J,1)}}}else{G.push(r.get("CHATUISVC_METHOD_INITIALIZEAX").toUpperCase());G.push(r.get("CHATUISVC_EVENT_ACCEPTCHAT").toUpperCase());G.push(r.get("CHATUISVC_EVENT_RESUMECHAT").toUpperCase())}return G}function j(H){var J=H.GetPropertyAsStr(r.get("CHATUISVC_TAG_DATA_FIELD"));
var G=H.GetPropertyAsStr(r.get("CHATUISVC_TAG_APPEND"));switch(J){case r.get("CHATUISVC_TAG_TRANSCRIPT"):var I=H.GetProperty(r.get("CHATUISVC_TAG_TRANSCRIPT"));h.call(this,I);break;case r.get("CHATCC_METADATA_CTRLNAME_TEXT"):break;case r.get("CHATCC_METADATA_CTRLNAME_URL"):break;case r.get("CHATCC_METADATA_CTRLNAME_KB"):break;default:break}}function w(G){var H=G.GetPropertyAsStr(r.get("CHATUISVC_TAG_CURRCHATID"));var I=this.Get("ChatTabMap")[H];if(I){this.SetProperty("ShowTypingMsg",I)}}function s(H,G){var J=this.Get("CurrentChat");var L="";if(J&&x(J)){L=J.Id;B.call(this,L)}var I=G.GetPropertyAsStr(r.get("CHATUISVC_TAG_CURRCHATID"));var K=G.Clone();K.SetPropertyStr(r.get("CHATUISVC_TAG_EVENTCHATID"),I);if(H===r.get("CHATUISVC_EVENT_RESUMECHAT")&&I!==L){K.SetProperty(r.get("CHATUISVC_TAG_NEEDTYPEINFO"),"TRUE")}this.ExecuteMethod("InvokeServiceMethod",r.get("CHATUISVC_METHOD_UPDATECHATDATA"),K);o.call(this,I)}function g(G){var J=G.GetPropertyAsStr(r.get("CHATUISVC_TAG_CURRCHATID"));var H=G.GetPropertyAsStr(r.get("CHATUISVC_TAG_EVENTCHATID"));var K=G.Clone();var I=this.ExecuteMethod("GetCurrChatId");if(I){t.call(this,I,r.get("CHATCC_METADATA_CTRLNAME_TEXT"),K);t.call(this,I,r.get("CHATCC_METADATA_CTRLNAME_URL"),K)}if(H!==J){K.SetProperty(r.get("CHATUISVC_TAG_EVENTCHATID"),"")}this.ExecuteMethod("InvokeServiceMethod",r.get("CHATUISVC_METHOD_UPDATECHATDATA"),K)}function y(H){var I=H.GetPropertyAsStr(r.get("CHATUISVC_TAG_CURRCHATID"));var G=this.Get("CurrentChat");var J=H.Clone();if(I&&G&&G.Id===I){if(x(G)){J.SetProperty(r.get("CHATUISVC_TAG_EVENTCHATID"),I);this.ExecuteMethod("InvokeServiceMethod",r.get("CHATUISVC_METHOD_REMOVECHATDATA"),J)}else{t.call(this,I,r.get("CHATCC_METADATA_CTRLNAME_TEXT"),J);t.call(this,I,r.get("CHATCC_METADATA_CTRLNAME_URL"),J);this.ExecuteMethod("InvokeServiceMethod",r.get("CHATUISVC_METHOD_SAVEINPUTFIELDS"),J)}B.call(this,I)}}function F(I,G){p(3,"OnSwitchChat: "+I+", "+G);var H=CCFMiscUtil_CreatePropSet();H.SetPropertyStr(r.get("CHATUISVC_TAG_CURRCHATID"),I);H.SetPropertyStr(r.get("CHATUISVC_TAG_NEWSELECTEDCHATID"),G);this.ExecuteMethod("InvokeServiceMethod",r.get("CHATUISVC_METHOD_SWITCHCHAT"),H)}function h(M,N){var L=this.Get("CurrentChat");if(!L){return}var I=L.Id;var J=this.Get("ChatTabMap");var K=J[I];if(K){if(A.IsEmpty(N)){N=true}if(!N){this.SetProperty("ChatClearLog",{chatId:I})}var G=this,H=0;$($.parseXML(M)).find("message, pushurl, system-message").each(function(){H++;if(!N||H>K.transcriptCnt){var T=$(this).context.nodeName.toUpperCase(),Q=$(this).attr("userName"),P=$(this).attr("timestamp"),R=($(this).attr("from")==="agent"),S=$.trim($(this).text());switch(T){case"MESSAGE":var O={chatId:I,userName:Q,text:S,timestamp:P,FromAgent:R};G.SetProperty("NewChatMessage",O);break;case"PUSHURL":break;case"SYSTEM-MESSAGE":var O={chatId:I,userName:"System Message",text:S,timestamp:P,FromAgent:false};G.SetProperty("NewChatMessage",O);break;default:break}}});K.transcriptCnt=H;if(H>0){G.SetProperty("ReadLastMessage",I)}}}function q(H){for(var I=0,G=H.GetChildCount();I<G;I++){var J=H.GetChild(I);if(J.GetType()===r.get("CHAT_PST_TYPE_LOCALE")){this.AddProperty("LocaleInfo",b.call(this,J))}}}function b(K){if(K.GetType()!==r.get("CHAT_PST_TYPE_LOCALE")){return}var J=true;var M;var H;var L={};for(var I=0,G=K.GetPropertyCount();I<G;I++){if(J){M=K.GetFirstProperty();J=false}else{M=K.GetNextProperty()}H=K.GetProperty(M);if(M===r.get("CHAT_PANE_CAPTION")){L.CAPTION=H}}return L}function f(){k.call(this);this.ExecuteMethod("InvokeServiceMethod",r.get("CHATUISVC_METHOD_INITIALIZEAX"))}function m(I){E.call(this,I);var J=I.GetProperty(r.get("CHATUISVC_TAG_TRANSCRIPT"));h.call(this,J,false);var L=this.Get("CurrentChat");if(L){var H=L[r.get("CHATCC_METADATA_CTRLNAME_TEXT")];this.ExecuteMethod("GetTextInputValue",L.Id);var K=this.Get("TextInput4Get");if(!K){this.SetProperty("TextInput4Set",H)}var M=L[r.get("CHATCC_METADATA_CTRLNAME_URL")];this.ExecuteMethod("GetUrlInputValue",L.Id);var G=this.Get("UrlInput4Get");if(!G){this.SetProperty("UrlInput4Set",M)}}}function E(H){if(!H){return}var M=this.Get("ChatTabMap");var K=H.GetProperty(r.get("CHATUISVC_TAG_CURRCHATID"));var L=H.GetProperty(r.get("CHATUISVC_TAG_CURRCHATONHOLD"));var G=null;for(var J=0;J<H.GetChildCount();J++){G=H.GetChild(J);if(G&&G.GetType()==="Tab"){var I=G.GetProperty(r.get("CHATUISVC_TAG_CHATID"));var N=M[I];if(!N){N={Id:I,agentTypingSentTime:0,transcriptCnt:0};M[I]=N}i(N,G);if(x(N)&&I!==K){c.call(this,I)}else{this.SetProperty("ChatUpdated",N)}if(I===K){this.SetProperty("CurrentChat",N);if(L&&!x(N)){B.call(this,I)}}}}this.SetProperty("ChatTabMap",M)}function i(L,H){var K=H.GetProperty(r.get("CHATUISVC_TAG_CAPTION"));var J=H.GetProperty(r.get("CHATUISVC_TAG_NEWMESSAGECOUNT"));var I=H.GetProperty(r.get("CHATUISVC_TAG_LASTMESSAGE"));var M=H.GetProperty(r.get("CHATUISVC_TAG_CHATSTATE"));L.state=M;L.caption=K;L.newMsgCnt=J;if(J>0){L.newMsg=I}var G=H.GetChildByType(r.get("CHATUISVC_TAG_TYPE_FIELD"));if(G){var N=G.EnumProperties(true);do{L[N]=G.GetProperty(N)}while((N=G.EnumProperties(false)))}}function x(G){return(G.state===r.get("CHATUISVC_CHATSTATE_TERMINATE"))}function B(J,I){var K=this.Get("ChatTabMap")[J];if(!K){p(1,"Holding chat info not found!");return}var H=this.Get("CurrentTabOnHold");if(!H){this.SetProperty("CurrentTabOnHold",K);H=K;this.SetProperty("ChatIdHold",J)}var G=this.Get("CurrentChat");if(G!==H){p(1,"Holding chat is not current!");return}if(!I&&x(K)){c.call(this,J,true);this.SetProperty("CurrentTabOnHold",null);this.SetProperty("CurrentChat",null)}}function o(G){var H=this.Get("ChatTabMap")[G];if(!H){p(1,"Resuming chat info not found!");return}this.SetProperty("CurrentTabOnHold",null);this.SetProperty("CurrentChat",H);this.SetProperty("ChatResumed",H)}function c(H,G){if(H){this.SetProperty("ChatIdRemoved",H);var I=this.Get("ChatTabMap");if(I.hasOwnProperty(H)){delete I[H];if(!G){var J=CCFMiscUtil_CreatePropSet();J.SetProperty(r.get("CHATUISVC_TAG_EVENTCHATID"),H);this.ExecuteMethod("InvokeServiceMethod",r.get("CHATUISVC_METHOD_REMOVECHATDATA"),J)}}}}function C(G){var K=G.GetPropertyAsStr(r.get("CHATUISVC_TAG_CURRCHATID"));var I=this.Get("CurrentChat");if(!I){p(1,"Fatal error, current chat is invalid!");return}var J=I.Id;if(K!==J){p(1,"Current chat id does not match!")}var H=G.Clone();H.SetPropertyStr(r.get("CHATUISVC_TAG_DATA_FIELD"),r.get("CHATUISVC_TAG_TRANSCRIPT"));H.SetPropertyStr(r.get("CHATUISVC_TAG_APPEND"),r.get("CHATUISVC_VALUE_YES"));this.ExecuteMethod("InvokeServiceMethod",r.get("CHATUISVC_METHOD_GETFIELDDATA"),H)}function u(G){}function z(G){}function t(J,L,H,I){if(L===r.get("CHATCC_METADATA_CTRLNAME_TEXT")){this.ExecuteMethod("GetTextInputValue",J);var G=this.Get("TextInput4Get");H.SetPropertyStr(r.get("CHATCC_METADATA_CTRLNAME_TEXT"),G);if(I){this.SetProperty("TextInput4Set","")}}else{if(L===r.get("CHATCC_METADATA_CTRLNAME_URL")){this.ExecuteMethod("GetUrlInputValue",J);var K=this.Get("UrlInput4Get");H.SetPropertyStr(r.get("CHATCC_METADATA_CTRLNAME_URL"),K);if(I){this.SetProperty("UrlInput4Set","")
}}}}function p(H,G){a(H,"chatpmodel.js: "+G)}function a(H,G){SiebelApp.S_App.CommToolbarUtil.Log(H,G)}function l(){var H=CCFMiscUtil_CreatePropSet();H.SetProperty(r.get("SWE_VIEW_ID_STR"),r.get("CHAT_PANE_VIEWNAME"));H.SetPropertyStr("SWEBS","1");var G=this.ExecuteMethod("GetCurrChatId");if(G){t.call(this,G,r.get("CHATCC_METADATA_CTRLNAME_TEXT"),H);t.call(this,G,r.get("CHATCC_METADATA_CTRLNAME_URL"),H)}this.ExecuteMethod("InvokeServiceMethod",r.get("CHATUISVC_METHOD_TOGGLECHATPANE"),H)}function n(){var G=true;var J=App();if(J===undefined||J===null){p(2,"App() failed!");return G}var H=App().GetMainView();if(H===undefined||H===null){p(2,"No main view found!");return G}var I=H.GetActiveApplet();if(I===undefined||I===null){p(2,"No active applet found!");return G}G=I.InvokeMethod("ImplicitCommit",CCFMiscUtil_CreatePropSet());return G}return e}())};