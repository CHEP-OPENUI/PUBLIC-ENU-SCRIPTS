/*<ORACLECOPYRIGHT>
* Copyright (C) 1994-2013 Oracle and/or its affiliates. All rights reserved.
* Oracle and Java are registered trademarks of Oracle and/or its affiliates.
* Other names may be trademarks of their respective owners.
* UNIX is a registered trademark of The Open Group.
*
* This software and related documentation are provided under a license agreement
* containing restrictions on use and disclosure and are protected by intellectual property laws.
* Except as expressly permitted in your license agreement or allowed by law, you may not use, copy,
* reproduce, translate, broadcast, modify, license, transmit, distribute, exhibit, perform, publish,
* or display any part, in any form, or by any means. Reverse engineering, disassembly,
* or decompilation of this software, unless required by law for interoperability, is prohibited.
*
* The information contained herein is subject to change without notice and is not warranted to be error-free.
* If you find any errors, please report them to us in writing.
*
* U.S. GOVERNMENT RIGHTS Programs, software, databases, and related documentation and technical data delivered to U.S.
* Government customers are "commercial computer software" or "commercial technical data" pursuant to the applicable
* Federal Acquisition Regulation and agency-specific supplemental regulations.
* As such, the use, duplication, disclosure, modification, and adaptation shall be subject to the restrictions and
* license terms set forth in the applicable Government contract, and, to the extent applicable by the terms of the
* Government contract, the additional rights set forth in FAR 52.227-19, Commercial Computer Software License
* (December 2007). Oracle America, Inc., 500 Oracle Parkway, Redwood City, CA 94065.
*
* This software or hardware is developed for general use in a variety of information management applications.
* It is not developed or intended for use in any inherently dangerous applications, including applications that
* may create a risk of personal injury. If you use this software or hardware in dangerous applications,
* then you shall be responsible to take all appropriate fail-safe, backup, redundancy,
* and other measures to ensure its safe use. Oracle Corporation and its affiliates disclaim any liability for any
* damages caused by use of this software or hardware in dangerous applications.
*
* This software or hardware and documentation may provide access to or information on content,
* products, and services from third parties. Oracle Corporation and its affiliates are not responsible for and
* expressly disclaim all warranties of any kind with respect to third-party content, products, and services.
* Oracle Corporation and its affiliates will not be responsible for any loss, costs,
* or damages incurred due to your access to or use of third-party content, products, or services.
</ORACLECOPYRIGHT>*/
if(typeof(SiebelApp.SyncThreadHandler)==="undefined"){SiebelJS.Namespace("SiebelApp.SyncThreadHandler");SiebelApp.SyncThreadHandler=(function(){var x=0;var w;var e;var b;var h;var g;var B;var r;var q;var y;var u;var a="";var k="";var m=window.location.origin;var C="";var D=-1;var n=false;var j=0;var s=SiebelApp.Constants;var v=SiebelApp.Offlineconstants;var o=SiebelApp.OfflineAppSettings;var p=window.location;var d=SiebelApp.OfflineUtils;var f;var c;function i(){var E;F=function F(){return E};F.prototype=this;E=new F();E.constructor=F;return E}function z(E){var F=JSON.stringify(E.data);d.CcfLogEvent([v.get("LOG_EVT_UPSYNC"),76,11,56,E.url,E.type,E.async,E.contentType,F])}function t(E){d.CcfLogEvent([v.get("LOG_EVT_COMMON"),77,11,56,E.data[2],E.data[3].readyState,E.data[1],E.data[3].status])}var A=new i();i.prototype.SyncInProgress=function(){return(x>0)};i.prototype.OnCall=function(K,N,L){var O=SiebelApp.S_App.GetScriptDir()+"siebel/offline/syncwebworker.js";var I=new Worker(O);var P;var G;var E=window.location.protocol;SiebelApp.S_App.uiStatus.Free();var F=SiebelApp.BrowserCacheMgr.GetSyncNodeId();u=SiebelApp.S_App.GetUserName();y=p.pathname.replace("start.swe","");y=y.replace(/\//g,"");y=y+"_sync";if(!n){n=o.GetPkgStatus()}if(x===0){if(k===""){k=K.pwd;if(k===""){I.terminate();return}}x=1;K.url=m+"/";K.url=K.url+y+"/start.swe";C=K.url;var Q=C;var H=SiebelApp.AjaxRequestMgr.SetSrvrReqInputProp(Q,[s.get("SWE_CMD_ARG"),"IsPortlet","SWEPassword","SWEUserName"],["ExecuteLogin",1,k,u],"",C);K.url=H;var M=H.indexOf("?");var J=H.substring(M+1,H.length);K.url=C;K.data=J;K.async=false;K.contentType="application/x-www-form-urlencoded";K.type="POST";k="";K.pwd="";SiebelApp.OfflineUtils.CcfLogEvent([v.get("LOG_EVT_UPSYNC"),28,11,56,u])}K.url=K.url.replace(K.url.substring(K.url.indexOf(E),K.url.indexOf(y)-1),window.location.origin);z(K);if(N){N.apply(this,L)}I.addEventListener("message",function(Z){d.CcfLogEvent([v.get("LOG_EVT_COMMON"),77,11,56,Z.data[2],Z.data[3].readyState,Z.data[1],Z.data[3].status]);if(Z.data[1]==="OK"){var ag="";var aa="";this.url=Z.data[2];b=Z.data[0];if(x===12||x===1||SiebelApp.OfflineAppMgr.CheckServerConnection(b)){var X=function(){x=x+1;ag=C;U=SiebelApp.AjaxRequestMgr.SetSrvrReqInputProp(ag,[s.get("SWE_CMD_ARG"),"SWEPreLd"],["Logoff",1],"",C);U=U+"&"+e;if(D===6){o.SetSyncStatus(false);o.SetMode(false);SiebelApp.S_App.CustomToolbar.Update("UpSyncDone");$(".progressbar").find("img").removeClass().addClass("appCacheProgress6");SiebelJS.Log("Synchronizing offline data... is Done");K.data="";K.type="GET"}K.url=U;I.terminate();SiebelApp.SyncThreadHandler.OnCall(K)};switch(x){case 1:var Y=b;h=b.search("_sn");b=b.substring(h);h=b.search("_sn");g=b.indexOf("&");w=b.substring(h,g);b=b.substring(g+1);h=b.search("SRN");b=b.substring(h);h=b.search("SRN");g=b.indexOf("&");if(g===-1){g=b.indexOf(" ");g=g-1;P=Y.indexOf(E);Y=Y.substring(P);P=Y.indexOf(E);G=Y.indexOf(" ");K.url=Y.substring(P,G-1);x=x+1}e=b.substring(h,g);var ab=e.split("=");if(ab[0]!=="SRN"||ab[1]===""||ab.length!==2){if(w){aa=SiebelApp.S_App.OfflineLocaleObject.GetLocalString("IDS_SWE_INVALID_OLD_PASSWORD");d.CcfLogEvent([v.get("LOG_EVT_COMMON"),27,11,56,aa]);alert(aa)}else{aa=SiebelApp.S_App.OfflineLocaleObject.GetLocalString("IDS_DOUI_ERR_SYNC");d.CcfLogEvent([v.get("LOG_EVT_COMMON"),27,11,56,aa]);alert(aa)}I.terminate();x=0;return}if((o.GetMode()===false)&&(n===false)){$("#_swecontent").prepend("<div id='progressbar' class ='progressbar'><img class = 'goOffline'src='images/white.gif'></img></div>")}K.data="";K.type="GET";I.terminate();SiebelApp.SyncThreadHandler.OnCall(K);break;case 2:x=x+1;h=b.search("src=");b=b.substring(h);h=b.search("src=");g=b.indexOf("SWETS=");if(g===-1){g=b.indexOf(" ");g=g-1;K.url=b.substring(h+5,g)}else{K.url=b.substring(h+5,g+6)}b=b.substring(g);h=b.indexOf("_sweattachment");b=b.substring(h);h=b.search("src=");b=b.substring(h);h=b.search("src=");g=b.indexOf("SWETS=");if(g===-1){g=b.indexOf(" ");g=g-1;B=b.substring(h+5,g)}else{B=b.substring(h+5,g+6)}I.terminate();SiebelApp.SyncThreadHandler.OnCall(K);break;case 3:K.url=B;x=x+1;P=b.indexOf(E);b=b.substring(P);P=b.indexOf(E);G=b.indexOf(")");r=b.substring(P,G-1);b=b.substring(G);P=b.indexOf("_sweclient`v`");b=b.substring(P+15);P=b.indexOf("?");G=b.indexOf("`");q=b.substring(P+1,G);I.terminate();SiebelApp.SyncThreadHandler.OnCall(K);break;case 4:K.url=r;x=x+1;if(o.GetSyncStatus()===false){x=x+2;if(n===true){x=x+1}}I.terminate();SiebelApp.SyncThreadHandler.OnCall(K);break;case 5:x=x+1;SiebelApp.S_App.CustomToolbar.Update("UpSync");$("#_swecontent").prepend("<div id='progressbar' class ='progressbar'><img class = 'appCacheProgress1'src='images/white.gif'></img></div>");ag=C;var U=SiebelApp.AjaxRequestMgr.SetSrvrReqInputProp(ag,[s.get("SWE_CMD_ARG"),s.get("SWE_ARG_KEEP_CONTEXT"),s.get("SWE_VIEW_RPC_ARG"),s.get("SYNC_NODE_ID")],["GetLastTxn",1,1,F],"",C);U=U+"&"+e;K.url=U;d.CcfLogEvent([v.get("LOG_EVT_UPSYNC"),49,11,56]);I.terminate();SiebelApp.SyncThreadHandler.OnCall(K);$(".progressbar").find("img").removeClass().addClass("appCacheProgress2");break;case 6:D=x;if(n===true){x=11}ag=C;U=SiebelApp.AjaxRequestMgr.SetSrvrReqInputProp(ag,[s.get("SWE_CMD_ARG"),s.get("SWE_ARG_KEEP_CONTEXT"),s.get("SWE_VIEW_RPC_ARG"),s.get("SYNC_NODE_ID")],["SynchronizeOfflineData",1,1,F],"",C);K.url=U;var ac=SiebelApp.SyncThreadHandler.ProcessUpSync(K.url,b,function(aj){if(aj){K.url=aj;var ai=aj.indexOf("?");var ah=aj.substring(ai+1,aj.length);K.url=C+"?"+e;K.data=ah;K.async=false;K.contentType="application/x-www-form-urlencoded";K.type="POST";I.terminate();SiebelApp.SyncThreadHandler.OnCall(K)}else{X()}});if(!ac){I.terminate()}break;case 7:var T=SiebelApp.S_App.IsAutoOn();if(!o.GetPkgStatus()&&o.GetMetadata()){F="";window.localStorage.setItem(s.get("SYNC_NODE_ID"),"")}x=x+1;ag=C;U=SiebelApp.AjaxRequestMgr.SetSrvrReqInputProp(ag,[s.get("SWE_CMD_ARG"),s.get("SWE_ARG_KEEP_CONTEXT"),s.get("SWE_VIEW_RPC_ARG"),s.get("SYNC_NODE_ID"),v.get("REGENERATEMETADATA"),s.get("SWE_IS_AUTO_ON")],["GoOffline",1,1,F,j,T],"",C);U=U+"&"+e;K.url=U;SiebelApp.S_App.CustomToolbar.Update("FullDownLoad");d.CcfLogEvent([v.get("LOG_EVT_COMMON"),79,11,56,d.GetTS()]);I.terminate();j=0;f=d.TimerFactory(function(){d.CcfLogEvent([v.get("LOG_EVT_COMMON"),41,11,56,""])},{onTimeout:function(){d.CcfLogEvent([v.get("LOG_EVT_COMMON"),41,11,56,"Timed out"])}});SiebelApp.SyncThreadHandler.OnCall(K);break;case 8:ac=true;if(f){f.stop()}var V={};if(n===false){V=SiebelApp.AjaxRequestMgr.ProcessToolbarResponse.apply(this,Z.data);ac=V.bContinue}if(F===""){F=SiebelApp.BrowserCacheMgr.GetSyncNodeId()}if(ac){ag=C;U=SiebelApp.AjaxRequestMgr.SetSrvrReqInputProp(ag,[s.get("SWE_CMD_ARG"),s.get("SWE_ARG_KEEP_CONTEXT"),s.get("SWE_VIEW_RPC_ARG"),s.get("SYNC_NODE_ID"),"LastSyncTimeStamp"],["GetOfflineData",1,1,F,window.localStorage.getItem("TS")],"",C);U=U+"&"+e;if(n){SiebelApp.S_App.CustomToolbar.Update("IncDataDownLoad");d.CcfLogEvent([v.get("LOG_EVT_COMMON"),80,11,56,d.GetTS()]);U=U+"&iSync=1";U=U+"&SRFId="+window.localStorage.getItem("SRFId")
}else{SiebelApp.S_App.CustomToolbar.Update("FullDownLoad");d.CcfLogEvent([v.get("LOG_EVT_COMMON"),81,11,56,d.GetTS()])}K.url=U;if(!n){x=x+2}else{x=x+1}I.terminate();c=d.TimerFactory(function(){d.CcfLogEvent([v.get("LOG_EVT_COMMON"),89,11,56,""])},{onTimeout:function(){d.CcfLogEvent([v.get("LOG_EVT_COMMON"),89,11,56,"Timed out"])}});if(V.callback){SiebelApp.SyncThreadHandler.OnCall(K,V.callback,V.args)}else{SiebelApp.SyncThreadHandler.OnCall(K)}}else{x=0;I.terminate()}break;case 9:var S=["IDS_DOUI_ERR_DATA_OUTDTD","IDS_DOUI_ERR_NODECHANGED_BKUP_DATA","IDS_DOUI_ERR_SRF_EXPIRED","IDS_DOUI_ERR_RESP_CHNG","IDS_DOUI_ERR_UPOSCHANGED_BKUP_DATA"];var ae=["Data_OutDated","Node_ReExtracted","SRF_Changed","Responsibilty_Changed","Position_Changed"];var ad=CCFMiscUtil_CreatePropSet();ad.DecodeFromString(b);var af=ad.GetType();if(af){af=af.toString()}var R=ae.indexOf(af);if(R!==-1){D=9;var W=S[R];var aa=SiebelApp.S_App.OfflineLocaleObject.GetLocalString(W);d.CcfLogEvent([v.get("LOG_EVT_COMMON"),27,11,56,aa]);alert(aa);x=7;D=-1;n=false;o.SetData(false);o.SetMetadata(false);$("#_swecontent").prepend("<div id='progressbar' class ='progressbar'><img class = 'goOffline'src='images/white.gif'></img></div>");if(R>1){o.SetSchemaStatus(1);if(R>2){j=1}}SiebelApp.SyncThreadHandler.OnCall(K);I.terminate()}else{$("#_swecontent").prepend("<div id='progressbar' class ='progressbar'><img class = 'goOffline'src='images/white.gif'></img></div>");SiebelApp.AjaxRequestMgr.ProcessToolbarResponse.apply(this,Z.data);ag=C;U=SiebelApp.AjaxRequestMgr.SetSrvrReqInputProp(ag,[s.get("SWE_CMD_ARG"),s.get("SWE_ARG_KEEP_CONTEXT"),s.get("SWE_VIEW_RPC_ARG"),s.get("SYNC_NODE_ID"),"ACK","LastSyncTimeStamp","iSync"],["GetOfflineData",1,1,F,1,window.localStorage.getItem("TS"),1],"",C);U=U+"&"+e;K.url=U;x=x+2;I.terminate();SiebelApp.SyncThreadHandler.OnCall(K)}break;case 10:if(c){c.stop()}SiebelApp.AjaxRequestMgr.ProcessToolbarResponse.apply(this,Z.data);x=x+1;ag=C;U=SiebelApp.AjaxRequestMgr.SetSrvrReqInputProp(ag,[s.get("SWE_CMD_ARG"),s.get("SWE_ARG_KEEP_CONTEXT"),s.get("SWE_VIEW_RPC_ARG"),s.get("SYNC_NODE_ID"),"ACK","LastSyncTimeStamp","iSync"],["GetOfflineData",1,1,F,1,window.localStorage.getItem("TS"),0],"",C);U=U+"&"+e;K.url=U;I.terminate();SiebelApp.SyncThreadHandler.OnCall(K);break;case 11:X();break;case 12:if(D===6){if(o.GetSyncStatus()===true){SiebelApp.S_App.CustomToolbar.Update("UpSyncFailed");d.CcfLogEvent([v.get("LOG_EVT_UPSYNC"),43,11,56]);$(".progressbar").remove()}else{SiebelApp.S_App.CustomToolbar.Update("UpSyncDone");d.CcfLogEvent([v.get("LOG_EVT_UPSYNC"),42,11,56]);$(".progressbar").find("img").removeClass().addClass("appCacheProgress6")}I.terminate();o.ReloadApp()}if(D===9){o.SetMode(false);$("div #GoOffline").find(".stati").removeClass("statusIncDataDownLoad");x=0;D=-1;I.terminate()}}}else{d.CcfLogEvent([v.get("LOG_EVT_COMMON"),90,11,56,Z.data[3].response,Z.data[3].responseText]);l.call(this)}I.terminate()}else{d.CcfLogEvent([v.get("LOG_EVT_COMMON"),88,11,56,Z.data[3].response,Z.data[3].responseText]);l.call(this)}},false);I.addEventListener("error",function(R){SiebelApp.OfflineUtils.CcfLogEvent([v.get("LOG_EVT_UPSYNC"),35,11,56,R.filename,R.lineno,R.message])},false);I.postMessage(K);return};function l(){var E="";if(x!==12){if(!o.GetMode()&&o.GetPkgStatus()){o.OnSuccessfulDataDownload();SiebelApp.OfflineUtils.CcfLogEvent([v.get("LOG_EVT_UPSYNC"),21,11,87]);p.replace(p.origin.concat(p.pathname))}else{E=SiebelApp.S_App.OfflineLocaleObject.GetLocalString("IDS_DOUI_ERR_SYNC");SiebelApp.OfflineUtils.CcfLogEvent([v.get("LOG_EVT_UPSYNC"),27,13,84,E]);alert(E)}x=0}}i.prototype.ProcessUpSync=function(E,H,K){var J=CCFMiscUtil_CreatePropSet();J.DecodeFromString(H);SiebelApp.OfflineUtils.CcfLogEvent([v.get("LOG_EVT_UPSYNC"),62,11,65,"started"]);if(SiebelApp.OfflineAppMgr.CheckValidation(J)){if(J.propArray.Status!=="OK"){SiebelApp.OfflineUtils.CcfLogEvent([v.get("LOG_EVT_UPSYNC"),63,11,65,J.propArray.Status]);SiebelJS.Log(J.propArray.Status);return false}else{a=J.propArray.TxnId;var I=a.indexOf(">");var F=a.substr(I+1,a.length);var G=F.indexOf("<");a=F.substr(0,G);SiebelApp.OfflineUtils.CcfLogEvent([v.get("LOG_EVT_UPSYNC"),64,11,65,a]);SiebelJS.Log("Last Transaction Id...."+a);SiebelJS.Log("Synchronizing offline data....");SiebelApp.SyncThreadHandler.UpSync(E,a,K);$(".progressbar").find("img").removeClass().addClass("appCacheProgress3");return true}}else{return false}};i.prototype.UpSync=function(E,F,G){SiebelApp.BrowserCacheMgr.GetItemsToSync(F);$.callback(this,function(I){var H=I.retVal;if(H){SiebelApp.OfflineUtils.CcfLogEvent([v.get("LOG_EVT_UPSYNC"),65,11,54,H.length]);if(H.length!==0){if(F!==""){SiebelApp.SyncThreadHandler.PurgeRecord(F)}$.callback(this,function(){var J=SiebelApp.SyncThreadHandler.SyncRequestBuilder(E,H);G.apply(this,[J])})}else{if(F!==""){SiebelApp.SyncThreadHandler.PurgeRecord(F);SiebelApp.SyncThreadHandler.UpSync(E,"",G)}else{G.apply(this)}}}else{if(F!==""){SiebelApp.SyncThreadHandler.PurgeRecord(F);SiebelApp.SyncThreadHandler.UpSync(E,"",G)}else{G.apply(this)}}})};i.prototype.PurgeRecord=function(G){var E=SiebelApp.OfflineCacheConfig.get("PRO_SYNCQUEUE_DB_TBL");var F=SiebelApp.OfflineCacheConfig.get("PRO_SYNCQUEUE_DB_TBL_COLS");SiebelApp.BrowserCacheMgr.Delete(E,F.TransactionId,G);SiebelApp.OfflineUtils.CcfLogEvent([v.get("LOG_EVT_UPSYNC"),66,11,55,G])};i.prototype.SyncRequestBuilder=function(E,H){var G;var J="~";var L="";var M=1;var F="";for(var I=0;I<H.length;I++){G="";G=H[I].Request;G=encodeURIComponent(G);L=L.concat(G,J)}if(L){L=L.slice(0,((L.length)-1));var K=L.split("~");var N=E;F=SiebelApp.AjaxRequestMgr.SetSrvrReqInputProp(N,[v.get("SYNC_PKG_LENGTH"),v.get("TOTAL_SYNC_PACKAGE_LENGTH"),v.get("SYNC_PKG_REQUESTS"),s.get("SYNC_NODE_ID"),v.get("END_OF_FILE")],[K.length,K.length,L,SiebelApp.BrowserCacheMgr.GetSyncNodeId(),M],"",C)}return F};return A}())};