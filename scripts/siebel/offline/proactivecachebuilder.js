/*<ORACLECOPYRIGHT>
* Copyright (C) 1994-2013 Oracle and/or its affiliates. All rights reserved.
* Oracle and Java are registered trademarks of Oracle and/or its affiliates.
* Other names may be trademarks of their respective owners.
* UNIX is a registered trademark of The Open Group.
*
* This software and related documentation are provided under a license agreement
* containing restrictions on use and disclosure and are protected by intellectual property laws.
* Except as expressly permitted in your license agreement or allowed by law, you may not use, copy,
* reproduce, translate, broadcast, modify, license, transmit, distribute, exhibit, perform, publish,
* or display any part, in any form, or by any means. Reverse engineering, disassembly,
* or decompilation of this software, unless required by law for interoperability, is prohibited.
*
* The information contained herein is subject to change without notice and is not warranted to be error-free.
* If you find any errors, please report them to us in writing.
*
* U.S. GOVERNMENT RIGHTS Programs, software, databases, and related documentation and technical data delivered to U.S.
* Government customers are "commercial computer software" or "commercial technical data" pursuant to the applicable
* Federal Acquisition Regulation and agency-specific supplemental regulations.
* As such, the use, duplication, disclosure, modification, and adaptation shall be subject to the restrictions and
* license terms set forth in the applicable Government contract, and, to the extent applicable by the terms of the
* Government contract, the additional rights set forth in FAR 52.227-19, Commercial Computer Software License
* (December 2007). Oracle America, Inc., 500 Oracle Parkway, Redwood City, CA 94065.
*
* This software or hardware is developed for general use in a variety of information management applications.
* It is not developed or intended for use in any inherently dangerous applications, including applications that
* may create a risk of personal injury. If you use this software or hardware in dangerous applications,
* then you shall be responsible to take all appropriate fail-safe, backup, redundancy,
* and other measures to ensure its safe use. Oracle Corporation and its affiliates disclaim any liability for any
* damages caused by use of this software or hardware in dangerous applications.
*
* This software or hardware and documentation may provide access to or information on content,
* products, and services from third parties. Oracle Corporation and its affiliates are not responsible for and
* expressly disclaim all warranties of any kind with respect to third-party content, products, and services.
* Oracle Corporation and its affiliates will not be responsible for any loss, costs,
* or damages incurred due to your access to or use of third-party content, products, or services.
</ORACLECOPYRIGHT>*/
if(typeof(SiebelApp.ProactiveCacheBuilder)==="undefined"){SiebelJS.Namespace("SiebelApp.ProactiveCacheBuilder");SiebelApp.ProactiveCacheBuilder=(function(){var y=new l();var C=SiebelApp.OfflineCacheConfig;var u=SiebelApp.Offlineconstants;var m=SiebelApp.OfflineAppSettings;var B=SiebelJS.Dependency("SiebelApp.Utils");var t=SiebelApp.Constants;var h=t.get("SWE_ROW_ID_FIELD");var g=u.get("METADATATABLEINFO");var q=u.get("TABLEINFO");var z=u.get("VIEW_NAME");var j=u.get("FLD_PICK_APLT_DET");var c=u.get("PICK_APLT_DET");var s=u.get("FLD_PICK_MAP");var x=u.get("PICK_MAP_INFO");var D=u.get("VIEW_INFO");var E=u.get("GOTOVIEW");var A=u.get("GETVIEWLAYOUT");var o=u.get("TEXT");var f=u.get("DEFAULT_VIEW_INFO");var n=u.get("GETCACHEDFRAME");var p=u.get("GOTOPOSTEDACTION");var i=SiebelApp.BrowserCacheMgr;var b={};var r=[];var a=window.localStorage;var v=SiebelApp.OfflineUtils;if(window.localStorage.getItem(q)){b=JSON.parse(a.getItem(q))}if(a.getItem(g)){r=JSON.parse(a.getItem(g))}function l(){var F;G=function G(){return F};G.prototype=this;F=new G();F.constructor=G;return F}l.prototype.ParseAndCacheData=function(J,G){var M=0;var F=J.GetChildCount();var H=m.GetSchemaStatus();var L=J.GetChildByType("SiebData");if(L){v.CcfLogEvent([u.get("LOG_EVT_DATA_EX_BASIC"),1,1,1,"data"]);$(".progressbar").find("img").removeClass().addClass("cachingData");SiebelApp.S_App.uiStatus.Busy({mask:true,timeOut:false});var K=L.GetProperty("ts");if(!K){K=""}var I=L.GetProperty("fSync");if(B.IsTrue(I)){this.ClearDataTables(false)}$.callback(this,function(){if(!F){v.CcfLogEvent([u.get("LOG_EVT_DATA_EX_BASIC"),16,1,1]);if(K){a.setItem("TS",K)}k.call(this);return}var O=J.GetChildByType("MetaData");var N=function(){a.setItem("TS",K);k.call(this)};var P=function(){SiebelApp.Metadata.Load(true);$.callback(this,function(){d.call(this,L,N,true,H,false)})};if(O){d.call(this,O,P,false,H,true)}else{P()}})}else{v.CcfLogEvent([u.get("LOG_EVT_DATA_EX_BASIC"),3,1,1,G]);$(".progressbar").remove();SiebelApp.S_App.CustomToolbar.Update("FullDownLoadFailed")}};function d(K,M,F,N,I){var J=K.GetChildCount();var G=false;var H=0;var L=function(){var ad=K.GetChild(H);var af=ad.GetType();var aa=af;var au={};var X=[];var S;var Z=ad.GetChildCount();for(var an=0;an<Z;an++){var W=ad.GetChild(an);au[W.GetType()]=W}af=v.RemoveNonAlphaChars(af);if(au.Schema!==undefined&&N!==2){var al;if(r.indexOf(af)!==-1){al=SiebelApp.SqlBuilder.DeleteTable(af);i.DeleteTable(al)}var ag=au.Schema.GetProperty("Schema");if(ag!==undefined){if(ag.indexOf("||")!==-1){SiebelJS.Log("Bad Schema for "+af+" :"+ag);ag=ag.replace(/||/g,"|")}G=true;X=ag.split("|");S=X.length;for(var ae=0;ae<S;ae++){X[ae]=v.RemoveNonAlphaChars(X[ae])}var at;var ai="";var av=au.Schema.GetProperty("UKCR");if(av==="0"&&F){ai=SiebelApp.Metadata.GetBCUnqKeys(aa)}at=SiebelApp.SqlBuilder.CreateTable(af,X,ai,F);v.CcfLogEvent([u.get("LOG_EVT_DATA_EX_BASIC"),4,1,2,af]);if(!I&&ai){v.CcfLogEvent([u.get("LOG_EVT_DATA_EX_DETAILED"),27,1,50,ai])}else{if(!I){v.CcfLogEvent([u.get("LOG_EVT_DATA_EX_DETAILED"),27,1,50," "])}}i.CreateTable(at,af,X);b[af]=X.join("`").toUpperCase().split("`");if(I){r.push(af)}}}if(au.Data!==undefined){if(au.Data.GetChildCount()){if(b[af]){S=b[af].length;X=b[af]}var ay=au.Data.GetChildCount();var ax=ay;var ac=[];var Y=[];var R=[];G=true;v.CcfLogEvent([u.get("LOG_EVT_DATA_EX_BASIC"),5,1,2,af,X.length,ay]);for(var ar=0;ar<ax;ar++){var P=au.Data.GetChild(ar);if(!P){continue}var aj=P.GetProperty("Record");if(!aj){continue}aj=aj.replace(/\\0/g,"|").replace(/\\1/g,"^").replace(/\\2/g,"~").replace(/\\4/g,"&").replace(/\\3/g,"\\");var U=(af==="MBCs")?aj.split("^"):aj.split("|");var am=U.length;for(var ap=0;ap<am;ap++){if(U[ap]===undefined||U[ap]===""){U[ap]=""}}if(am!==S){v.CcfLogEvent([u.get("LOG_EVT_DATA_EX_BASIC"),6,1,2,S,am,af]);if(am<S){var ah=S-am;for(ap=0;ap<ah;ap++){U.push("")}}}if(P.GetValue()==="U"){Y.push(U)}else{if(P.GetValue()==="I"){R.push(U)}else{ac.push(U)}}}if(ac.length){i.InsertRecordSet(af,X,ac)}var ao=R.length;var aq=Y.length;var T=X.length;if(ao||aq){var ab=0;for(var aw=0;aw<T;aw++){if(X[aw]==="ID"){ab=aw;break}}var ak=0;var V=function(az){if(!az.err&&(az.retVal<=0)){i.InsertRecord(af,X,Y[ak])}};var O=function(aB){ak=aB;var aC=Y[ak];var aA=(aC)[ab];var az=SiebelApp.SqlBuilder.UpdateRecord(af,X,aC,h,aA);return[az,aA]};if(aq){var Q={iterations:aq,execute:i.UpdateRecord,executeScope:i,postExecute:V,preExecute:O};$.eachAsyncOp(this,Q)}$.callback(this,function(aB){if(!aB.err){if(ao){var aA=w.call(this,R,ab);var az=SiebelApp.SqlBuilder.SelectRecord(af,aA,["ID"]);i.Execute(az.selectQuery,az.valList,true);$.callback(this,function(aE){if(!aE.err){var aI=aE.retVal;var aK=aI.length;var aG=[];var aC=[];if(aK){var aJ;for(var aD=0;aD<ao;aD++){var aF=aA[aD].Val;aJ=false;for(var aH=0;aH<aK;aH++){if(aF===aI[aH].Id){aJ=true;aG.push(R[aD]);break}}if(!aJ){aC.push(R[aD])}}}else{aC=R}i.InsertRecordSet(af,X,aC);$.callback(this,function(aN){var aL=aG.length;if(aL){var aM=0;var aP=function(aR){aM=aR;var aS=aG[aM];var aQ=aS[ab];var aT=SiebelApp.SqlBuilder.UpdateRecord(af,X,aS,h,aQ);return[aT,aQ]};if(aL){var aO={iterations:aL,execute:i.UpdateRecord,executeScope:i,postExecute:null,preExecute:aP};$.eachAsyncOp(this,aO)}}})}})}}})}}}$.callback(this,function(){if(au.drid!==undefined){var az;var aA=au.drid.GetProperty("Record");if(aA){if(aA.indexOf("|")!==-1){aA=aA.replace(/\|/g,"','")}aA="'"+aA+"'";G=true;az=SiebelApp.SqlBuilder.DeleteMutlipleRecord(af,h,aA);i.Execute(az)}}$.callback(this,function(){H++;if(H<J){L.call(this)}})})};if(H<J){L.call(this)}$.callback(this,function(){if(G){i.GetBrowserStorage().SetPostTxnCallback(M)}else{M.call(this)}})}function w(K,J){var H=[];var I;var F=K.length;for(var G=0;G<F;G++){I={};I.FieldName="ID";if(G!==0){I.PreLogic="OR"}I.Val=K[G][J];H.push(I)}return H}function k(){$(".progressbar").find("img").removeClass().addClass("offlinePackageEnd");SiebelApp.S_App.uiStatus.Free();setTimeout(function(){$(".progressbar").remove();a.setItem(q,JSON.stringify(b));a.setItem(g,JSON.stringify(r));v.CcfLogEvent([u.get("LOG_EVT_DATA_EX_BASIC"),7,1,3]);SiebelApp.S_App.CustomToolbar.Update();if(m.GetMode()===true){var F=JSON.parse(a.getItem("StringCache"));if(F){SiebelApp.S_App.SetStringCache(F)}}var G=this;m.OnSuccessfulDataDownload(true);if(a.getItem("appCacheDone")&&JSON.parse(a.getItem("appCacheDone"))){m.ReloadToOffline()}},1000)}l.prototype.ParseAndCacheMetadata=function(L){v.CcfLogEvent([u.get("LOG_EVT_METADATA_EX"),1,1,4,"Metadata"]);var M=L.GetChildCount();var S=m.GetSchemaStatus();var Q;var I;var G;var H;var T=[];var F=C.get("PRO_METADATASTORE_DB_TBL_COLS");if(S===1){v.CcfLogEvent([u.get("LOG_EVT_METADATA_EX"),8,1,4]);var P=v.GetOfflineCacheConfig(C.get("PRO_METADATASTORE_DB"));var R=P.tables;var O=R.length;var N;var K=function(U){if(R[U]==="Metadata"){var V="Type";var W="!=";N=SiebelApp.SqlBuilder.DeleteRecords(R[U],[V],null,W);return[N,[f]]}else{N=SiebelApp.SqlBuilder.DeleteRecords(R[U]);return[N]}};var J={execute:i.Execute,executeScope:i,preExecute:K,iterations:O};
$.eachAsyncOp(this,J);$.callback(this,function(){this.ClearDataTables(true)})}$.callback(this,function(){v.CcfLogEvent([u.get("LOG_EVT_METADATA_EX"),9,1,4]);var Z=L.GetProperty("sc");i.CacheSCMap(Z);for(var Y=0;Y<M;Y++){var ac=[];Q=L.GetChild(Y);I=Q.GetType();H=Q.GetProperty(z);switch(I){case j:G=Q.GetProperty(c);e.call(this,I,G);continue;case s:G=Q.GetProperty(x);e.call(this,I,G);continue;case D:if(H!==undefined){T.push(H)}break}var X=Object.keys(Q.propArray);var ab=X.length;for(var U=0;U<ab;U++){if(X[U]!==z){ac.push(X[U])}}var aa=ac.length;for(var W=0;W<aa;W++){var V=Q.propArray[ac[W]];if(V){i.InsertRecord(C.get("PRO_METADATASTORE_DB_TBL"),[F.ObjName,F.SweCmd,F.Response,F.Type],[H,ac[W],V,I])}}}v.CcfLogEvent([u.get("LOG_EVT_METADATA_EX"),26,1,4,JSON.stringify(T).replace(/,/g," ")]);i.CacheViewList(T);m.OnSuccessfulMetaDataDownload()})};l.prototype.ClearDataTables=function(F){var J=JSON.parse(a.getItem(u.get("TABLEINFO")));var K=[];var G;var M={};var I=0;for(var H in J){if(J[H]&&(r.indexOf(H)===-1)){G=H;if(G){if(F){K[I]=SiebelApp.SqlBuilder.DeleteTable(G)}else{K[I]=SiebelApp.SqlBuilder.DeleteRecords(G)}I++}}}var L=function(O){var N=K[O];return[N]};M={execute:i.Execute,executeScope:i,preExecute:L,iterations:I};$.eachAsyncOp(this,M)};function e(M,J){var N;var I;if(B.IsEmpty(J)||B.IsEmpty(M)){v.CcfLogEvent([u.get("LOG_EVT_METADATA_EX"),22,1,8]);return}switch(M){case j:N=C.get("PRO_DB_PICKAPPLET_INFO_TBL_COLS");I=J.split("|");if(I&&I.length===3){i.InsertRecord(C.get("PRO_DB_PICKAPPLET_INFO_TBL"),[N.FldInfo,N.PickApplet],[I[0]+"|"+I[1],I[2]])}else{v.CcfLogEvent([u.get("LOG_EVT_METADATA_EX"),23,1,8,"Pick Applet Info",J])}break;case s:N=C.get("PRO_DB_PICKFLD_MAP_TBL_COLS");I=J.split("|");if(I&&I.length===3){var Q="null";var P=I[2];var H=P.split(",");var K=H.length;P="";for(var G=0;G<K;G++){if(!H[G]){continue}var L=H[G].split(":");var O=L.length;if(O>=2){if(L[0]&&L[1]){var F=L[0]+":"+L[1];P+=F+",";if(O===3&&L[2]==="1"){Q=F}}}else{v.CcfLogEvent([u.get("LOG_EVT_METADATA_EX"),24,1,8,H[G]])}}P=v.RTrim(P,",");i.InsertRecord(C.get("PRO_DB_PICKFLD_MAP_TBL"),[N.BCName,N.FldName,N.PMap,N.PConstraint],[I[0],I[1],P,Q])}else{v.CcfLogEvent(u.get("LOG_EVT_METADATA_EX"),"23",["Field Pick map Info",J])}break}}l.prototype.ProcessGoOnline=function(){SiebelApp.S_App.uiStatus.Busy({mask:true,timeOut:false});m.SetMode((!m.GetMode()));m.SetSyncStatus(false);SiebelApp.S_App.CustomToolbar.Update();if(SiebelApp.S_App.GetTimer()){var F=SiebelApp.S_App.GetTimer().GetLogBuffer();a.setItem(t.get("SWE_PERF_LOG_DATA"),JSON.stringify(F))}m.ReloadApp()};return y}())};